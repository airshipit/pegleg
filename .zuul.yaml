# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

- project:
    templates:
      - release-notes-jobs-python3
      - docs-on-readthedocs
    vars:
      rtd_webhook_id: '38574'
      rtd_project_name: 'airship-pegleg'
      proxy: ""
      no_proxy: ""
      use_proxy: false
      docker_registry: "quay.io"
      docker_registry_login_url: "https://quay.io/api/v1/"
      deb_docker_repo: "{{ zuul_site_mirror_fqdn }}/deb-docker/{{ ansible_distribution_release }}"
      image_prefix: "airshipit"
      base_image_noble: "quay.io/airshipit/ubuntu:noble"
      base_image_jammy: "quay.io/airshipit/ubuntu:jammy"
      base_image_focal: "ubuntu:20.04"
      base_image_bionic: "ubuntu:18.04"
      base_image_opensuse: "opensuse/leap:15.1"
      base_image_xenial: "ubuntu:16.04"
    check:
      jobs:
        - openstack-tox-py312
        - openstack-tox-pep8-noble
        - openstack-tox-cover-noble
        - pegleg-dependency-vulnerability-check
        - airship-pegleg-validate-airskiff-manifests-noble
        - airship-pegleg-docker-build-gate-ubuntu_noble
        - airship-pegleg-lint-yaml

    gate:
      jobs:
        - openstack-tox-py312
        - openstack-tox-pep8-noble
        - openstack-tox-cover-noble
        - pegleg-dependency-vulnerability-check
        - airship-pegleg-validate-airskiff-manifests-noble
        - airship-pegleg-docker-build-gate-ubuntu_noble
        - airship-pegleg-lint-yaml
    post:
      jobs:
        - airship-pegleg-docker-publish-ubuntu_noble
        - pegleg-upload-git-mirror
        - trigger-readthedocs-webhook

- nodeset:
    name: airship-pegleg-single-node-noble
    nodes:
      - name: primary
        label: ubuntu-noble

- nodeset:
    name: airship-pegleg-single-node-jammy
    nodes:
      - name: primary
        label: ubuntu-jammy

- job:
    name: openstack-tox-pep8-noble
    parent: openstack-tox-pep8
    nodeset: openstack-single-node-noble


- job:
    name: openstack-tox-cover-noble
    parent: openstack-tox-cover
    nodeset: openstack-single-node-noble


- job:
    name: airship-pegleg-lint-yaml
    voting: true
    timeout: 600
    run: tools/gate/playbooks/lint-yaml.yaml
    nodeset: ubuntu-noble
    irrelevant-files:
      - ^.*\.rst$
      - ^doc/.*$

- job:
    name: pegleg-dependency-vulnerability-check
    parent: tox-py312
    voting: false
    timeout: 600
    nodeset: ubuntu-noble
    vars:
      tox_envlist: safety
      bindep_profile: test py312

- job:
    name: airship-pegleg-docker-build-gate-ubuntu_noble
    timeout: 7200
    run: tools/gate/playbooks/docker-image-build.yaml
    nodeset: airship-pegleg-single-node-noble
    irrelevant-files:
      - '^doc/.*'
    vars:
      publish: false
      distro: ubuntu_noble
      tags:
        dynamic:
          patch_set: true

- job:
    name: airship-pegleg-validate-airskiff-manifests-noble
    description: |
      Test pegleg Airskiff site manifest validation
    parent: treasuremap-airskiff-infra-deploy-base
    nodeset: treasuremap-airskiff-1node-ubuntu_noble
    run:
      - tools/gate/playbooks/airship-run-scripts.yaml
      - tools/gate/playbooks/airskiff-validate.yaml
    required-projects:
      - name: airship/treasuremap
        override-checkout: v1.9
    roles:
      - zuul: airship/treasuremap
    vars:
      treasuremap_ref: v1.9
      CLONE_PEGLEG: false
      MAKE_PEGLEG_IMAGES: true
      USE_ARMADA_GO: false
      DISTRO: ubuntu_noble
      DOCKER_REGISTRY: localhost:5000
      gate_scripts_relative_path: ../../airship/treasuremap
      gate_scripts:
        - ./tools/deployment/airskiff/developer/000-clone-dependencies.sh
        - ./tools/deployment/airskiff/developer/017-make-all-images.sh
        - ./tools/deployment/airskiff/developer/022-generate_security_keys.sh

- job:
    name: airship-pegleg-docker-publish-ubuntu_noble
    timeout: 7200
    run: tools/gate/playbooks/docker-image-build.yaml
    nodeset: airship-pegleg-single-node-noble
    secrets:
      - airship_pegleg_quay_creds_2026
    irrelevant-files:
      - '^doc/.*'
    vars:
      publish: true
      distro: ubuntu_noble
      tags:
        dynamic:
          branch: true
          commit: true
        static:
          - latest
          - airflow_3.1.5

- secret:
    name: airship_pegleg_quay_creds_2026
    data:
      username: !encrypted/pkcs1-oaep
        - pmIJFWWIDSSzy2X8ZaHWUvUnGXIjNABgnKTvMQl9iaBsVZBPBwsBtzJEf+mhgWMxGJ6H5
          jOrf9hG5zJd7sjaYcjuwywxLZkDx9oIuZ1msz5uX0rt7Uh+XlaGOvE7Xd367kOVZEKbPY
          WhafG267Y5DYYWzT1rnfM1spbpI3hdPTBH9ocQrk42twNAJdAkB1nuOHxnI+qSd6zZEYy
          ih8yhhi3IXVqCEJDRoBWBXrD0bo7Mr5my3pWTnmkI8aTixaWLvH2Re3+5tFLRs0O2RKHX
          8sh70mG563HR3DUc3nuniUrxIi25NleJUIqkaklvHH0hY7Et5G0yD95MXhiNwwCiKIplI
          kH0bmOk22o8AjACwcEkYiskuk23qiwBrFFKYaQxb9a2Y3ZZqXNyTg0vlvwANSu4xU8uI3
          cmvOPz0ztrmnXxUwr+vRY6iVh1oKKNaDQnatRpDl0teIT37STsNYKxL4VGNYfpj1gHjrR
          oh100+SL0WqLjLqQO0ZegPzU4B5br/QaM6wlYusL+3MjJoDcKw899Ds+6zcASwzJ3ch6I
          GC7zUTuMPJNEUDAZF6jnOY1jgmrOJJQfoWzBKeeome3kkfEXz2y0T6jfpHfvMXdfc1BA+
          41QqUZ6G/Bet5RFSB5YFhVWk+7rdgGafO2kOapw965O1Y9JI5EFO/UlMCe4qZI=
      password: !encrypted/pkcs1-oaep
        - h1zw4QR/bbv09wosF936x6VwLwNwLBb+Qv1VFk0nX8rbeI15oP19t6d83fM3Jrnh7vRMz
          erFjBdg6EzGm4RdXMoNGhazFiV5RAuhHdpe0Cf4uZ54CYa1HQslRx4UTi3Qyij/zWTQ0+
          +wTrWg93ICRWpDKdlbIjjB7coZkBnnhVcO77K4zkbpIeY4+K5LYr3+JNm/uuSk9vZSnmA
          GwLDzEUSRt0/OaaC+dRhpRPO/H9Wi9hftm8p1vQd2B0srfNYiU7en7vXi+FTK8uFaFFc5
          P6rc9IQ8PquR8rGqe8CfWnO/uassP4v/dpVopGebNNl8I7vPsgzldaOxavDaF2vBgV/ow
          njRqiEhAn2u6MKemhf/3PqBAODaXR4glVhoWS5cbPJZFEM8N0ImdANNQxb99FrHEAhd85
          Wn/AaHv2g2L7iLKEzwnR2ZIMJxIDjNxoBdcHi9PPeEVg8+I9vzatj67iWQe2JwBnSv8sB
          cS3+ZDFVYs3JdYLOlk26kt6N2ZHMHjHn/i6mMkdA+x7CKt54a61xdE5A0Lk/IaFyV4D+W
          pqurO9g0I429GtQPLVzkRDLmabXXZ55qStLfj8+5Bn6HL7zxsw+g/Cre3ohZMBdeS94GJ
          N5lCztJAc/DfsV+u8GorGBT3KoLk2g72UF7Wi3Fpsil/3Eha5mdUrJXm91n298=

- job:
    name: pegleg-upload-git-mirror
    parent: upload-git-mirror
    description: Mirrors airship/pegleg to airshipit/pegleg
    vars:
      git_mirror_repository: airshipit/pegleg
    secrets:
      - name: git_mirror_credentials
        secret: pegleg-airshipit-github-ed25519-secret-2026-01-13
        pass-to-parent: true

- secret:
    name: pegleg-airshipit-github-ed25519-secret-2026-01-13
    data:
      user: git
      host: github.com
      host_key: github.com ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIOMqqnkVzrm0SdG6UOoqKLsabgH5C9okWi0dh2l9GKJl
      ssh_key: !encrypted/pkcs1-oaep
        - qp1NzNH2tBc4HVWkt20i3K6p2wj/G8tCY3EzQHQRNcmfx5tCG0cjSbxYE6gPwwENcaPOu
          ZEi+Yh0Qc0SSkI4awT71RzbAFkhaOHQotOUHw57VvAHKS7znV06hJYeyky+bPzWhE7n8+
          0yFjHYhReFP313+dUE4N9oK6Aje/up0FyzfXKKar1/qSOzsFjPiS1h3kXCqYiM+EjVg4B
          3C5TZyKUvaq8Xg97ScrPGSmO2Jl/ulDgTkaLu+jym5H0L7rpc9qrdoSQolGQNu8z5ch0s
          FCqKPG47tHwZn7yilKN1iakGtzc4MMdCkxb5C1Ok9ws322s7KmeeIVLbkxfQ1paMB00Hu
          BYBqh8GBPoqYKpKjNCitFpLslUqI97oVKzF1tVat77LHLzuYaMDzviJe+Uq0qSqNb2Jzw
          waqUYyo1fan3cHHNW32tvTC88OlTyohyVsjMpREr0X2LgBS5HCPA9ItJsBsKkEKs6oZDl
          hGLJpy+hGxK3woUBk0Ac+aTakKTpi9Ave5yn8ML4XvoV6tymgBX9UVxLnoT6XKOmztrAD
          XDN65v8s1cdiJViTeshm4fryu3gA58GbVTBa9CfhmkGDXxC1+t5KT0jSmB3ogL6I/o+u6
          8ye/1gpzp2RyKsqwnxARhGtuRlDrNoqjI2e+y1DbgZqDJOvGEOsg+fLmiAJWaw=
